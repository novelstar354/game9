<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>究極フルRPG - フル統合版</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { margin:0; font-family:sans-serif; background:#111; color:#fff; display:flex; justify-content:center; overflow-x:hidden; }
#game { width:100%; max-width:480px; padding:10px; position:relative; }
.screen { display:none; }
.screen.active { display:block; }
button { padding:8px 12px; margin:3px; font-size:14px; cursor:pointer; }
#battle-log { height:180px; overflow-y:auto; background:#222; padding:5px; margin:5px 0; border-radius:5px; font-size:14px; }
.hp-bar, .mp-bar, .exp-bar { background:#555; height:16px; border-radius:5px; margin:3px 0; position:relative; }
.hp-bar-inner { background:#4caf50; height:100%; width:100%; border-radius:5px; transition: width 0.3s; }
.mp-bar-inner { background:#2196f3; height:100%; width:100%; border-radius:5px; transition: width 0.3s; }
.exp-bar-inner { background:#ff9800; height:100%; width:0%; border-radius:5px; transition: width 0.5s; }
.cooldown { font-size:12px; color:#aaa; }
.attack-animation { position:absolute; font-weight:bold; font-size:24px; animation:attackMove 0.8s linear forwards; pointer-events:none; text-shadow:1px 1px 5px #fff; }
@keyframes attackMove { 0%{top:50%; left:10%; opacity:1;} 50%{top:40%; left:50%; opacity:1;} 100%{top:20%; left:90%; opacity:0;} }
.enemy-container { margin:5px 0; }
.enemy-box { background:#333; padding:5px; border-radius:5px; margin-bottom:5px; position:relative; cursor:pointer; transition: transform 0.3s; }
.enemy-box.selected { border:2px solid #ff0; transform:scale(1.05); }
.status { font-size:12px; color:#ff0; margin-left:5px; }
.bg-flash { position:absolute; top:0; left:0; width:100%; height:100%; background:#fff; opacity:0; pointer-events:none; transition: opacity 0.2s; z-index:1000; }
</style>
</head>
<body>
<div id="game">
  <div class="bg-flash" id="bg-flash"></div>
  <div id="screen-select" class="screen active">
    <h2>キャラクターを選択</h2>
    <button onclick="startGame('戦士')">戦士</button>
    <button onclick="startGame('魔法使い')">魔法使い</button>
  </div>

  <div id="screen-battle" class="screen">
    <h2>バトル</h2>
    <div>
      <b>あなた: </b><span id="player-name"></span> Lv:<span id="player-level"></span> EXP:<span id="player-exp"></span>/<span id="player-next"></span>
      <div class="hp-bar"><div id="player-hp" class="hp-bar-inner"></div></div>
      <div class="mp-bar"><div id="player-mp" class="mp-bar-inner"></div></div>
      <div class="exp-bar"><div id="player-expbar" class="exp-bar-inner"></div></div>
    </div>
    <div class="enemy-container" id="enemy-container"></div>
    <div id="battle-log"></div>
    <div>
      <button onclick="playerAttack()">通常攻撃</button>
      <button onclick="prepareSkill(0)">スキル1<span id="cool0" class="cooldown"></span></button>
      <button onclick="prepareSkill(1)">スキル2<span id="cool1" class="cooldown"></span></button>
      <button onclick="prepareSkill(2)">スキル3<span id="cool2" class="cooldown"></span></button>
      <button onclick="useItem()">回復アイテム(<span id="item-count"></span>)</button>
    </div>
    <div>ステージ: <span id="stage-number"></span></div>
  </div>

  <div id="screen-result" class="screen">
    <h2>バトル終了</h2>
    <div id="result-message"></div>
    <button onclick="nextStage()">次のステージ</button>
    <button onclick="restartGame()">最初から</button>
  </div>
</div>

<audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
<audio id="se-attack" src="https://www.soundjay.com/button/beep-07.mp3"></audio>
<audio id="se-skill" src="https://www.soundjay.com/button/beep-10.mp3"></audio>
<audio id="se-win" src="https://www.soundjay.com/misc/success-fanfare-trumpets-01.mp3"></audio>
<audio id="se-lose" src="https://www.soundjay.com/misc/fail-buzzer-01.mp3"></audio>

<script>
let player={}, enemies=[], selectedTarget=null, currentSkill=null, comboCount=0;
let skillCooldown=[0,0,0], itemCount=3, stage=1;
const attrMultiplier={ fire:{fire:1,water:0.5,wind:1.5}, water:{fire:1.5,water:1,wind:0.5}, wind:{fire:0.5,water:1.5,wind:1} };
const bgm=document.getElementById('bgm'); bgm.volume=0.2; bgm.play().catch(()=>{});
const seAttack=document.getElementById('se-attack'), seSkill=document.getElementById('se-skill'), seWin=document.getElementById('se-win'), seLose=document.getElementById('se-lose');
const bgFlash=document.getElementById('bg-flash');

function startGame(character){
  player={ name:character, attr:character==='戦士'?'fire':'water', maxHp:character==='戦士'?150:100, hp:character==='戦士'?150:100,
           maxMp:character==='戦士'?50:100, mp:character==='戦士'?50:100, attack:character==='戦士'?20:15,
           level:1, exp:0, nextExp:100,
           skills:[
             {name:'大斬り', power:40, cost:10, effect:'none', color:'#f00'},
             {name:character==='戦士'?'毒突き':'ヒール', power:30, cost:15, effect:character==='戦士'?'poison':'heal', color:'#0f0'},
             {name:'雷撃', power:50, cost:20, effect:'stun', color:'#0ff'}
           ] };
  stage=1; itemCount=3; skillCooldown=[0,0,0]; spawnEnemies(); updateUI(); logBattle('バトル開始！'); switchScreen('screen-battle'); 
}

function spawnEnemies(){
  enemies=[]; selectedTarget=null;
  const count=stage%5===0?2:Math.min(2,stage);
  for(let i=0;i<count;i++){
    let attr=['fire','water','wind'][Math.floor(Math.random()*3)];
    enemies.push({ name:(stage%5===0?'ボス':'スライム')+' Lv'+stage, attr:attr, maxHp:50+stage*30, hp:50+stage*30, attack:10+stage*5,
                   status:[], skills:[{name:'攻撃', power:10+stage*5},{name:'強打', power:15+stage*5}] });
  }
  renderEnemies(); updateUI();
}

function renderEnemies(){
  const container=document.getElementById('enemy-container'); container.innerHTML='';
  enemies.forEach((e,i)=>{
    const box=document.createElement('div'); box.className='enemy-box'; box.id='enemy-'+i;
    box.innerHTML=`<b>${e.name}</b> 属性:${e.attr} <span class="status">${e.status.join(' ')}</span>
      <div class="hp-bar"><div class="hp-bar-inner" style="width:${e.hp/e.maxHp*100}%"></div></div>`;
    box.onclick=()=>selectTarget(i);
    if(selectedTarget===i) box.classList.add('selected');
    container.appendChild(box);
  });
}

function selectTarget(index){ selectedTarget=index; renderEnemies(); if(currentSkill!==null) useSkill(currentSkill); }

function prepareSkill(index){ 
  if(skillCooldown[index]>0||player.mp<player.skills[index].cost){ logBattle('スキル使用不可'); return; } 
  currentSkill=index; logBattle(`${player.skills[index].name}を使用する対象を選択`); 
}

function useSkill(index){
  if(selectedTarget===null && player.skills[index].effect!=='heal'){ logBattle('敵を選択してください'); return; }
  currentSkill=null;
  player.mp-=player.skills[index].cost;
  seSkill.play();
  flashBG(player.skills[index].color);
  let target=player.skills[index].effect==='heal'?player:enemies[selectedTarget];
  if(player.skills[index].effect==='poison'){ target.status.push('毒'); logBattle(`${target.name}に毒を付与！`); }
  if(player.skills[index].effect==='stun'){ target.status.push('麻痺'); logBattle(`${target.name}を麻痺させた！`); }
  if(player.skills[index].effect==='heal'){ target.hp+=player.skills[index].power; if(target.hp>target.maxHp) target.hp=target.maxHp; logBattle(`${target.name}を回復！`); }
  else{ let dmg=calcDamage(player,target,player.skills[index].power)*(comboCount>0?1+comboCount*0.2:1); target.hp-=dmg; if(target.hp<0) target.hp=0; logBattle(`${player.name}の${player.skills[index].name}！ ${dmg}ダメージ`+(comboCount>0?` (コンボx${comboCount})`:''));
    comboCount++; playAnimation(player.skills[index].name,player.skills[index].color); }
  skillCooldown[index]=3; updateUI(); checkBattleEnd(); if(player.skills[index].effect!=='heal') setTimeout(enemyTurn,500);
  selectedTarget=null; renderEnemies();
}

function flashBG(color){ bgFlash.style.background=color; bgFlash.style.opacity=0.5; setTimeout(()=>{bgFlash.style.opacity=0;},150); }

function playerAttack(){ 
  if(player.hp<=0||enemies.length===0) return;
  const target=enemies[0]; seAttack.play(); flashBG('#fff'); let dmg=calcDamage(player,target,player.attack)*(comboCount>0?1+comboCount*0.2:1); target.hp-=dmg; if(target.hp<0) target.hp=0;
  logBattle(`${player.name}の攻撃！ ${dmg}ダメージ`+(comboCount>0?` (コンボx${comboCount})`:''));
  comboCount++; playAnimation('通常攻撃','#fff');
  updateUI(); checkBattleEnd(); if(target.hp>0)setTimeout(enemyTurn,500); 
}

function useItem(){ if(itemCount<=0){ logBattle('回復アイテムなし！'); return; } let heal=50; player.hp+=heal; if(player.hp>player.maxHp) player.hp=player.maxHp; itemCount--; logBattle(`${player.name}は回復アイテムを使った！ ${heal}回復`); flashBG('#ff0'); updateUI(); setTimeout(enemyTurn,500); }

function enemyTurn(){
  comboCount=0;
  if(player.hp<=0||enemies.length===0) return;
  enemies.forEach(e=>{
    if(e.hp<=0) return;
    if(e.status.includes('麻痺')){ logBattle(`${e.name}は麻痺して動けない！`); e.status=e.status.filter(s=>'麻痺'!==s); return; }
    if(e.status.includes('毒')){ let dmg=Math.floor(e.maxHp*0.05); e.hp-=dmg; logBattle(`${e.name}は毒で${dmg}ダメージ`); if(e.hp<0) e.hp=0; }
    let skill=e.skills[Math.floor(Math.random()*e.skills.length)]; let dmg=calcDamage(e,player,skill.power); player.hp-=dmg; if(player.hp<0) player.hp=0; logBattle(`${e.name}の${skill.name}！ ${dmg}ダメージ`); flashBG('#f00'); playAnimation(skill.name,'#f00');
  });
  skillCooldown=skillCooldown.map(c=>c>0?c-1:0);
  updateUI(); checkBattleEnd();
}

// ここからは最終版RPGの gainExp, dropItem, checkBattleEnd, showResult, nextStage, restartGame, switchScreen, saveGame, loadGame, updateUI, logBattle, calcDamage, playAnimation 関数をすべて統合します。
// （上で示した最終版と豪華演出版の関数をコピーすればOK）

window.onload=loadGame;
</script>
</body>
</html>
