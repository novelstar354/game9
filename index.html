<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>統合RPG</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
 <link rel="icon" href="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRGX8pcpJnGD9pbgap93Od8y8PjDyz3D5FNPDkyVT7ctw&s=10" sizes="16×16" type="image/png" />  
<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;display:flex;justify-content:center;overflow-x:hidden;}
#game{width:100%;max-width:480px;padding:10px;position:relative;}
.screen{display:none;}
.screen.active{display:block;}
button{padding:8px 12px;margin:3px;font-size:14px;cursor:pointer;}
#battle-log{height:180px;overflow-y:auto;background:#222;padding:5px;margin:5px 0;border-radius:5px;font-size:14px;}
.hp-bar,.mp-bar,.exp-bar{background:#555;height:16px;border-radius:5px;margin:3px 0;position:relative;}
.hp-bar-inner{background:#4caf50;height:100%;width:100%;border-radius:5px;transition:width 0.3s;}
.mp-bar-inner{background:#2196f3;height:100%;width:100%;border-radius:5px;transition:width 0.3s;}
.exp-bar-inner{background:#ff9800;height:100%;width:0%;border-radius:5px;transition:width 0.5s;}
.cooldown{font-size:12px;color:#aaa;}
.enemy-container{margin:5px 0;position:relative;}
.enemy-box{background:#333;padding:5px;border-radius:5px;margin-bottom:5px;position:relative;cursor:pointer;transition: all 0.3s;}
.enemy-box.selected{border:2px solid #ff0;transform:scale(1.05);}
.status{font-size:12px;color:#ff0;margin-left:5px;}
.bg-flash{position:absolute;top:0;left:0;width:100%;height:100%;background:#fff;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:1000;}
#player-container{position:relative;height:150px;}
#player-img,.enemy-img{position:absolute;bottom:0;width:80px;transition: all 0.3s;}
.effect-img{position:absolute;width:60px;height:60px;pointer-events:none;animation:effectMove 0.8s forwards;}
@keyframes effectMove{0%{opacity:1;}100%{opacity:0;transform:translateY(-50px) scale(1.5);}}
h1{text-align:center;margin-top:50px;}
.start-btn{text-align:center;margin-top:30px;}
</style>
</head>
<body>
<div id="game">
<div class="bg-flash" id="bg-flash"></div>

<!-- スタート画面 -->
<div id="screen-start" class="screen active">
<h1>統合RPG</h1>
<div class="start-btn">
  <button onclick="switchScreen('screen-select')">ゲーム開始</button>
  <button onclick="deleteSave()">セーブ削除</button>
</div>
</div>

<!-- キャラクター選択 -->
<div id="screen-select" class="screen">
<h2>キャラクター選択</h2>
<button onclick="startGame('戦士')">戦士</button>
<button onclick="startGame('魔法使い')">魔法使い</button>
</div>

<!-- バトル画面 -->
<div id="screen-battle" class="screen">
<h2>バトル</h2>
<div>
<b>あなた: </b><span id="player-name"></span> Lv:<span id="player-level"></span> EXP:<span id="player-exp"></span>/<span id="player-next"></span>
<div class="hp-bar"><div id="player-hp" class="hp-bar-inner"></div></div>
<div class="mp-bar"><div id="player-mp" class="mp-bar-inner"></div></div>
<div class="exp-bar"><div id="player-expbar" class="exp-bar-inner"></div></div>
</div>
<div id="player-container"><img id="player-img" src=""></div>
<div class="enemy-container" id="enemy-container"></div>
<div id="battle-log"></div>
<div>
<button onclick="playerAttack()">通常攻撃</button>
<button onclick="prepareSkill(0)" id="skill0">スキル1<span id="cool0" class="cooldown"></span></button>
<button onclick="prepareSkill(1)" id="skill1">スキル2<span id="cool1" class="cooldown"></span></button>
<button onclick="prepareSkill(2)" id="skill2">スキル3<span id="cool2" class="cooldown"></span></button>
<button onclick="useItem()">回復アイテム(<span id="item-count"></span>)</button>
</div>
<div>ステージ: <span id="stage-number"></span></div>
</div>

<!-- リザルト画面 -->
<div id="screen-result" class="screen">
<h2>バトル終了</h2>
<div id="result-message"></div>
<button onclick="nextStage()">次のステージ</button>
<button onclick="restartGame()">最初から</button>
</div>
</div>

<audio id="bgm" loop src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3"></audio>
<audio id="se-attack" src="https://www.soundjay.com/button/beep-07.mp3"></audio>
<audio id="se-skill" src="https://www.soundjay.com/button/beep-10.mp3"></audio>
<audio id="se-win" src="https://www.soundjay.com/misc/success-fanfare-trumpets-01.mp3"></audio>
<audio id="se-lose" src="https://www.soundjay.com/misc/fail-buzzer-01.mp3"></audio>

<script>
let player={}, enemies=[], selectedTarget=null, currentSkill=null, skillCooldown=[0,0,0], itemCount=3, stage=1;
const attrMultiplier={ fire:{fire:1,water:0.5,wind:1.5}, water:{fire:1.5,water:1,wind:0.5}, wind:{fire:0.5,water:1.5,wind:1} };
const bgm=document.getElementById('bgm'); bgm.volume=0.2; bgm.play().catch(()=>{});
const seAttack=document.getElementById('se-attack'), seSkill=document.getElementById('se-skill'), seWin=document.getElementById('se-win'), seLose=document.getElementById('se-lose');
const bgFlash=document.getElementById('bg-flash');

function switchScreen(screenId){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(screenId).classList.add('active');
}

function startGame(character){
  player={
    name:character, attr:character==='戦士'?'fire':'water',
    maxHp:character==='戦士'?150:100, hp:character==='戦士'?150:100,
    maxMp:character==='戦士'?50:100, mp:character==='戦士'?50:100, attack:character==='戦士'?20:15,
    level:1, exp:0, nextExp:100,
    skills:[
      {name:'大斬り', power:40, cost:10, effect:'none', color:'#f00', img:'https://i.imgur.com/9bX8hEX.gif', desc:'単体に大ダメージ'},
      {name:character==='戦士'?'毒突き':'ヒール', power:30, cost:15, effect:character==='戦士'?'poison':'heal', color:'#0f0', img:'https://i.imgur.com/9bX8hEX.gif',
       desc:character==='戦士'?'毒で毎ターンダメージ':'HPを回復'},
      {name:'雷撃', power:50, cost:20, effect:'stun', color:'#0ff', img:'https://i.imgur.com/9bX8hEX.gif', desc:'敵を一定確率でスタン'}
    ]
  };
  document.getElementById('player-img').src=character==='戦士'?'https://i.imgur.com/5n0n4lW.gif':'https://i.imgur.com/YOUR_MAGIC_GIF.gif';
  stage=1; itemCount=3; skillCooldown=[0,0,0];
  loadGame(); spawnEnemies(); updateUI(); logBattle('バトル開始！'); switchScreen('screen-battle'); updateSkillButtons();
}

// -------------------- ゲーム本体 --------------------
function spawnEnemies(){
  enemies=[]; selectedTarget=null;
  const container=document.getElementById('enemy-container'); container.innerHTML='';
  const enemyCount=Math.min(stage,3);
  for(let i=0;i<enemyCount;i++){
    let enemy={ name:`敵${i+1}`, attr:['fire','water','wind'][Math.floor(Math.random()*3)],
      maxHp:50+stage*10, hp:50+stage*10, attack:5+stage*2, status:'none'};
    enemies.push(enemy);
    const div=document.createElement('div'); div.className='enemy-box';
    div.innerHTML=`${enemy.name} <span class="status"></span>`;
    div.onclick=()=>{ selectEnemy(i); };
    container.appendChild(div);
  }
  updateUI();
}

function selectEnemy(index){
  selectedTarget=index;
  document.querySelectorAll('.enemy-box').forEach((e,i)=>e.classList.toggle('selected',i===index));
}

function playerAttack(){
  if(selectedTarget===null){ logBattle('ターゲットを選んでください'); return; }
  const enemy=enemies[selectedTarget];
  let damage=player.attack*(attrMultiplier[player.attr][enemy.attr]||1);
  enemy.hp-=damage; logBattle(`${player.name}の攻撃！${enemy.name}に${damage}ダメージ`);
  seAttack.play(); showEffect('attack',selectedTarget);
  checkEnemyDefeat(); enemyTurn(); updateUI(); saveGame();
}

function prepareSkill(skillIndex){
  if(skillCooldown[skillIndex]>0){ logBattle('クール中です'); return; }
  if(player.mp<player.skills[skillIndex].cost){ logBattle('MPが足りません'); return; }
  currentSkill=skillIndex; useSkill(skillIndex);
}

function useSkill(skillIndex){
  if(selectedTarget===null && player.skills[skillIndex].effect!=='heal'){ logBattle('ターゲットを選んでください'); return; }
  const skill=player.skills[skillIndex]; 
  player.mp-=skill.cost; skillCooldown[skillIndex]=3;
  if(skill.effect==='heal'){
    player.hp=Math.min(player.maxHp,player.hp+skill.power);
    logBattle(`${player.name}の${skill.name}！効果: ${skill.desc} HP+${skill.power}`);
  } else {
    const enemy=enemies[selectedTarget];
    let damage=skill.power*(attrMultiplier[player.attr][enemy.attr]||1);
    enemy.hp-=damage;
    logBattle(`${player.name}の${skill.name}！効果: ${skill.desc} ${enemy.name}に${damage}ダメージ`);
  }
  seSkill.play(); showEffect(skillIndex,selectedTarget);
  checkEnemyDefeat(); enemyTurn(); updateUI(); saveGame();
}

function enemyTurn(){
  enemies.forEach((enemy,i)=>{
    if(enemy.hp<=0) return;
    let damage=enemy.attack; player.hp-=damage;
    logBattle(`${enemy.name}の攻撃！${player.name}に${damage}ダメージ`);
    showEffect('enemy',i);
  });
  if(player.hp<=0){ gameOver(); } reduceCooldown(); updateUI(); saveGame();
}

function checkEnemyDefeat(){
  enemies.forEach((e,i)=>{
    if(e.hp<=0){
      const div=document.querySelectorAll('.enemy-box')[i]; div.style.opacity=0.5;
      logBattle(`${e.name}を倒した！`);
    }
  });
  if(enemies.every(e=>e.hp<=0)){
    stage++; logBattle('ステージクリア！'); seWin.play();
    setTimeout(nextStage,1000);
  }
}

function nextStage(){ spawnEnemies(); updateUI(); saveGame(); }

function useItem(){
  if(itemCount<=0){ logBattle('アイテムがありません'); return; }
  player.hp=Math.min(player.maxHp,player.hp+50); itemCount--;
  logBattle('回復アイテム使用！HP+50'); updateUI(); saveGame();
}

function reduceCooldown(){ skillCooldown=skillCooldown.map(c=>c>0?c-1:0); }

function logBattle(msg){
  const log=document.getElementById('battle-log'); log.innerHTML+=msg+'<br>'; log.scrollTop=log.scrollHeight;
}

function showEffect(type,index){
  const container=document.getElementById('player-container');
  const img=document.createElement('img'); img.className='effect-img';
  img.src='https://i.imgur.com/9bX8hEX.gif'; container.appendChild(img);
  setTimeout(()=>{ img.remove(); },800);
}

function gameOver(){
  logBattle('ゲームオーバー...'); seLose.play();
  switchScreen('screen-result'); document.getElementById('result-message').textContent=`ステージ${stage}で敗北`;
}

function restartGame(){ localStorage.removeItem('rpgSave'); startGame(player.name); updateUI(); }

function updateUI(){
  document.getElementById('player-name').textContent=player.name;
  document.getElementById('player-level').textContent=player.level;
  document.getElementById('player-exp').textContent=player.exp;
  document.getElementById('player-next').textContent=player.nextExp;
  document.getElementById('player-hp').style.width=(player.hp/player.maxHp*100)+'%';
  document.getElementById('player-mp').style.width=(player.mp/player.maxMp*100)+'%';
  skillCooldown.forEach((c,i)=>{ document.getElementById('cool'+i).textContent=c>0?`(${c})`:''; });
  document.getElementById('item-count').textContent=itemCount;
  document.getElementById('stage-number').textContent=stage;
}

function updateSkillButtons(){
  player.skills.forEach((s,i)=>{
    const btn=document.getElementById('skill'+i);
    btn.title = s.desc;
  });
}

// -------------------- セーブ・ロード --------------------
function saveGame(){
  const saveData={player,stage,skillCooldown,itemCount,enemies};
  localStorage.setItem('rpgSave',JSON.stringify(saveData));
}

function loadGame(){
  const save=localStorage.getItem('rpgSave');
  if(save){
    const data=JSON.parse(save); player=data.player; stage=data.stage; skillCooldown=data.skillCooldown;
    itemCount=data.itemCount; enemies=data.enemies; logBattle('セーブデータをロードしました'); updateUI();
  }
}

// -------------------- セーブ削除 --------------------
function deleteSave(){
  if(confirm('本当にセーブを削除しますか？')){
    localStorage.removeItem('rpgSave');
    logBattle('セーブデータを削除しました');
    alert('セーブデータを削除しました');
  }
}
</script>
</body>
</html>
